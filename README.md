# Сервис пакетной конвертации кадастровых данных

## Оглавление
- [Описание](#описание)
- [Требования](#требования)
- [Установка](#установка)
- [Структура](#структура)
- [Разработка](#разработка)
- [Развертывание](#развертывание)

## Описание
Сервис позволяет выполнять пакетную конвертацию кадастровых выписок в наборы геоданных в форматы Shapefile, GPKG, GeoJSON и MapInfo TAB. Конвертация осуществляется через NextGIS Toolbox и поддерживает те же опции конвертации, что и сам внешний сервис.

## Требования
- Python 3.12
- Poetry
- Docker
- Docker compose
- npm

## Установка
1. Клонируйте репозиторий и перейдите в каталог проекта:
    ```bash
    git clone https://github.com/ProkhorKondratev/ngw_kpt.git
    cd ngw_kpt
    ```

## Структура
Проект состоит из двух основных частей:
- **Backend**:
    - Производит обработку данных через набор сервисов (*services*).
    - Управляется хендлером (*services/handler.py*), который отвечает за взаимодействие между компонентами.

- **Frontend**:
    - Панель статистики (*Panel.js*).
    - Таблица (*Table.js*) для отображения результатов конвертации.
    - Загрузчик (*Uploader.js*) для пакетной загрузки исходных данных.

В папке `share` хранятся данные, которые будут переданы при развертывании на удалённом сервере.

## Разработка
Для запуска сервиса в режиме разработки необходимо:

1. Установить зависимости (из корня проекта):
- **Backend**:
    ```bash
    (cd backend && poetry install)
    ```
- **Frontend**:
    ```bash
    (cd frontend && npm install)
    ```

2. Активировать окружение:
    ```bash
    source backend/.venv/bin/activate
    ```

2. Выполнить запуск redis:
    ```bash
    docker compose up -d
    ```

- **Backend**:
    ```bash
    (cd backend && fastapi dev)
    ```
    ```bash
    # Опционально:
    (cd backend && celery -A app.services.worker worker --loglevel=info --concurrency=1)
    ```

- **Frontend**:
    ```bash
    (cd frontend && npm run start)
    ```

## Развертывание
Для развертывания на удалённом сервере выполните следующие шаги:

1. Из корня проекта выполните скрипт сборки:
    ```bash
    ./build.sh
    ```
    В результате сборки в папке `share` будут сохранены образы всех элементов проекта.

2. Для развертывания на удалённом сервере выполните:
    ```bash
    ./deploy.sh
    ```
    Это приведёт к удаленной остановке текущей версии сервиса, переустановке и запуску новой версии на сервере.

    > **Примечание:** Параметры подключение к внешнему серверу и другие опции конфигурируются непосредственно в скрипте `deploy.sh`.
